# Technical Specification

This is the technical specification for the spec detailed in @.agent-os/specs/2025-11-24-pdf-generation/spec.md

> Created: 2025-11-24
> Version: 1.0.0

## Technical Requirements

### PDF Library Integration

**ChromicPDF Setup:**
- Add `{:chromic_pdf, "~> 1.15"}` to mix.exs dependencies
- Configure ChromicPDF supervisor in application supervision tree
- Set up temporary file handling for PDF generation
- Configure PDF rendering options (page size, margins, form field support)

**Alternative Consideration:**
- Evaluate `pdf_generator` library as fallback if form field preservation is challenging with ChromicPDF
- May need to use `pdftk` or `pypdf` for form field manipulation

### API Endpoints

**Character PDF Export:**
```
GET /api/v2/characters/:id/pdf
Authentication: Required (JWT token)
Authorization: User must have access to character's campaign
Response: Binary PDF file with Content-Type: application/pdf
Headers: Content-Disposition: attachment; filename="character-name.pdf"
```

**Character PDF Import:**
```
POST /api/v2/characters/import_pdf
Authentication: Required (JWT token)
Parameters:
  - file: PDF upload (multipart/form-data)
  - campaign_id: Target campaign UUID
Response: JSON with created character data
```

### Character Sheet Template

**HTML Structure:**
- Create `lib/shot_web/templates/pdf/character_sheet.html.eex`
- Match existing Rails PDF layout with form field structure
- Use semantic HTML with proper field naming for form export

**CSS Styling:**
- Create `assets/css/pdf_character_sheet.css`
- Define print-optimized styles (letter size, proper margins)
- Match visual design of existing character sheet
- Ensure font sizes are readable when printed

### Field Mapping Service

**Elixir Module: `Shot.Services.CharacterPdfMapper`**

Functions:
- `to_pdf_fields(character)` - Convert Character struct to map of PDF form fields
- `from_pdf_fields(pdf_data)` - Parse PDF form data into Character changeset
- Field name mappings for all character attributes (stats, skills, schticks, weapons)

Field categories:
1. Basic Info: name, player, archetype, description
2. Core Stats: Body, Chi, Fortune, Mind, Reflexes
3. Derived Stats: Defense, Speed, Toughness, Wounds
4. Skills: All skill types with ratings
5. Schticks: Name, description, pagename for each schtick
6. Weapons: Name, damage, concealment, juncture, count

## Approach

### Phase 1: PDF Export Implementation

1. Install and configure ChromicPDF
2. Create HTML/CSS character sheet template
3. Implement `CharacterPdfMapper.to_pdf_fields/1`
4. Create PDF controller action for export
5. Add route for PDF download endpoint

### Phase 2: PDF Import Implementation

1. Add PDF upload handling to controller
2. Implement PDF parsing (extract form field data)
3. Implement `CharacterPdfMapper.from_pdf_fields/1`
4. Create character creation logic from parsed data
5. Add validation and error handling

### Phase 3: Testing and Refinement

1. Test PDF export with various character types (PC, NPC, boss, mook)
2. Test PDF import with different data scenarios
3. Verify form fields are properly fillable in PDF readers
4. Validate data accuracy in round-trip (export â†’ import)
5. Performance testing for PDF generation

## External Dependencies

### Required Libraries

**Elixir Dependencies:**
- `chromic_pdf` ~> 1.15 - HTML to PDF conversion with form field support
- Potential fallback: `pdf_generator` or system `wkhtmltopdf`

**System Dependencies:**
- Chromium browser binary (for ChromicPDF rendering)
- May need `pdftk` for form field manipulation

**Configuration Requirements:**
- Chromium path configuration in prod environment
- Temporary file storage for PDF generation
- File upload size limits for PDF import

### Rails Codebase Reference

**Files to reference for implementation:**
- Rails PDF controller: `shot-server/app/controllers/api/v1/characters_controller.rb` (PDF actions)
- PDF template: `shot-server/app/views/characters/show.pdf.erb`
- Field mapping logic: Character serializer PDF methods
- Form field definitions: Existing PDF form structure

**Migration Notes:**
- Verify all PDF form field names match between Rails and Elixir implementations
- Ensure character data serialization is consistent with Rails output
- Maintain backward compatibility with PDFs generated by Rails backend
